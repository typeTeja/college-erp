// ---------------------
// DATABASE & GENERATOR
// ---------------------
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}


// ---------------------
// GLOBAL MODELS
// ---------------------

model User {
  id          Int       @id @default(autoincrement())
  email       String    @unique
  phone       String?   @unique
  password    String
  isActive    Boolean   @default(true)
  lastLoginAt DateTime? 

  roles       UserRole[]
  refreshTokens RefreshToken[]
  otps        Otp[]

  student     Student?
  faculty     Faculty?
  notifications Notification[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Role {
  id          Int       @id @default(autoincrement())
  name        String    @unique // e.g., SUPER_ADMIN, ADMIN, STUDENT, PARENT
  permissions Json?     // { "module": ["READ", "WRITE"] }
  
  users       UserRole[]
}

model UserRole {
  userId      Int
  roleId      Int
  assignedAt  DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role        Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model RefreshToken {
  id          Int      @id @default(autoincrement())
  userId      Int
  tokenHash   String   @unique
  expiresAt   DateTime
  isRevoked   Boolean  @default(false)
  deviceInfo  String?
  ipAddress   String?
  
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Otp {
  id          Int      @id @default(autoincrement())
  userId      Int?     // Nullable because some OTPs might be pre-registration (e.g. valid mobile check) or focused on mobile number
  mobile      String
  code        String
  type        OtpType  @default(LOGIN)
  expiresAt   DateTime
  isUsed      Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([mobile])
}

enum OtpType {
  LOGIN
  PASSWORD_RESET
  VERIFICATION
}


// ---------------------
// ADMISSIONS MODULE
// ---------------------

model AdmissionApplication {
  id              Int       @id @default(autoincrement())
  fullName        String
  dob             DateTime
  phone           String
  email           String
  courseId        Int
  status          AdmissionStatus @default(PENDING)
  paymentStatus   PaymentStatus   @default(PENDING)
  easebuzzRef     String?  
  documents       Json?

  scholarship     Int?      
  omrSheetUrl     String?
  entranceScore   Float?    // Added missing field

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  course          Course   @relation(fields: [courseId], references: [id])
}

enum AdmissionStatus {
  PENDING
  VERIFIED
  TENTATIVE
  CONFIRMED
  REJECTED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}


// ---------------------
// STUDENT MASTER
// ---------------------

model Student {
  id                Int      @id @default(autoincrement())
  userId            Int      @unique
  admissionNumber   String   @unique
  courseId          Int
  semesterId        Int
  sectionId         Int?

  parentName        String?
  parentPhone       String?
  address           String?

  documents         Json?    // Aadhaar, PAN, TC, migration, originals
  profilePhotoUrl   String?
  
  aadhaarNumber     String?  @unique // Added for uniqueness check
  panNumber         String?  // Added missing field

  status            StudentStatus @default(ACTIVE)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id])
  course            Course   @relation(fields: [courseId], references: [id])
  semester          Semester @relation(fields: [semesterId], references: [id])
  section           Section? @relation(fields: [sectionId], references: [id])

  attendanceRecords AttendanceRecord[]
  examMarks         ExamMark[]
  fees              FeeTransaction[]
  hostel            HostelAllocation?
  libraryLogs       LibraryLog[]
  odcRecords        OdcRecord[]
  placements        PlacementApplication[]
  issues            StudentIssue[]
}

enum StudentStatus {
  ACTIVE
  DETAINED
  PASSOUT
  DROPPED
  ALUMNI
}


// ---------------------
// ACADEMIC STRUCTURE
// ---------------------

model Course {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  years    Int
  
  admissions AdmissionApplication[] // Added relation
  students   Student[]
  yearsRel   CourseYear[]
  fees       FeeStructure[] // Added relation
}

model CourseYear {
  id        Int        @id @default(autoincrement())
  courseId  Int
  year      Int

  course    Course     @relation(fields: [courseId], references: [id])
  semesters Semester[]
}

model Semester {
  id        Int       @id @default(autoincrement())
  courseYearId Int
  name      String

  courseYear CourseYear @relation(fields: [courseYearId], references: [id])
  subjects   Subject[]
  students   Student[]
  sections   Section[]
  exams      Exam[] // Added relation
}

model Section {
  id          Int       @id @default(autoincrement())
  name        String
  semesterId  Int

  semester    Semester  @relation(fields: [semesterId], references: [id])
  students    Student[]
  timetable   TimetableSlot[] // Added relation
}

model Subject {
  id          Int      @id @default(autoincrement())
  name        String
  code        String   @unique
  type        SubjectType
  semesterId  Int

  weeklyHours Int?
  totalHours  Int?

  semester    Semester @relation(fields: [semesterId], references: [id])
  timetable   TimetableSlot[]
  lessons     LessonPlan[]
  questions   QuestionBank[]
  examMarks   ExamMark[] // Added relation
}

enum SubjectType {
  THEORY
  PRACTICAL
  ELECTIVE
  AUDIT
}


// ---------------------
// LESSON PLAN
// ---------------------

model LessonPlan {
  id         Int     @id @default(autoincrement())
  subjectId  Int
  unit       Int
  topic      String
  subtopics  Json?
  hours      Int?
  status     String? // Added status (Pending/Completed)

  assignments Assignment[]

  subject    Subject @relation(fields: [subjectId], references: [id])
}

model Assignment {
  id          Int     @id @default(autoincrement())
  lessonPlanId Int
  title       String
  type        AssignmentType
  maxMarks    Int
  dueDate     DateTime?

  lessonPlan  LessonPlan @relation(fields: [lessonPlanId], references: [id])
}

enum AssignmentType {
  WRITTEN
  CASE_STUDY
  PRESENTATION
  PROJECT
}


// ---------------------
// TIMETABLE
// ---------------------

model TimetableSlot {
  id          Int      @id @default(autoincrement())
  subjectId   Int
  facultyId   Int
  sectionId   Int?
  dayOfWeek   Int
  startTime   String
  endTime     String

  subject     Subject   @relation(fields: [subjectId], references: [id])
  faculty     Faculty   @relation(fields: [facultyId], references: [id])
  section     Section?  @relation(fields: [sectionId], references: [id])

  attendance  AttendanceRecord[]
}


// ---------------------
// FACULTY + LEAVE
// ---------------------

model Faculty {
  id           Int      @id @default(autoincrement())
  userId       Int      @unique
  department   String?
  qualification String?
  workload      Json?
  employeeId    String? @unique // Added missing field

  leaves        FacultyLeave[]
  substitutions FacultyLeave[] @relation("Substitute") // Added missing relation
  timetable     TimetableSlot[]

  user          User    @relation(fields: [userId], references: [id])
}

model FacultyLeave {
  id          Int        @id @default(autoincrement())
  facultyId   Int
  type        LeaveType
  status      LeaveStatus @default(PENDING)
  startDate   DateTime
  endDate     DateTime
  reason      String?
  
  substituteId Int?      // Added missing field
  substitute   Faculty?  @relation("Substitute", fields: [substituteId], references: [id])

  faculty     Faculty @relation(fields: [facultyId], references: [id])
}

enum LeaveType {
  CL
  SL
  EL
  LOP
  COMP_OFF
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}


// ---------------------
// ATTENDANCE
// ---------------------

model AttendanceRecord {
  id              Int       @id @default(autoincrement())
  studentId       Int
  timetableSlotId Int
  date            DateTime
  status          AttendanceStatus

  student         Student       @relation(fields: [studentId], references: [id])
  timetableSlot   TimetableSlot @relation(fields: [timetableSlotId], references: [id])
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  OD
  LEAVE
  LATE
}


// ---------------------
// EXAMS + QUESTION BANK
// ---------------------

model Exam {
  id         Int      @id @default(autoincrement())
  name       String
  type       ExamType
  date       DateTime
  semesterId Int

  semester   Semester @relation(fields: [semesterId], references: [id])
  marks      ExamMark[]
}

enum ExamType {
  MID1
  MID2
  FINAL
  REEXAM
}

model ExamMark {
  id         Int     @id @default(autoincrement())
  examId     Int
  studentId  Int
  subjectId  Int
  marks      Int?

  exam       Exam     @relation(fields: [examId], references: [id])
  student    Student  @relation(fields: [studentId], references: [id])
  subject    Subject  @relation(fields: [subjectId], references: [id])
}

model QuestionBank {
  id          Int     @id @default(autoincrement())
  subjectId   Int
  question    String
  type        QuestionType
  difficulty  Difficulty
  metadata    Json?

  subject     Subject @relation(fields: [subjectId], references: [id])
}

enum QuestionType {
  MCQ
  SHORT
  LONG
  CASE_STUDY
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}


// ---------------------
// FEES & FINANCE
// ---------------------

model FeeStructure {
  id        Int      @id @default(autoincrement())
  courseId  Int
  year      Int
  amount    Int
  installments Json? // Added missing field [DueDate, Amount]

  course    Course   @relation(fields: [courseId], references: [id])
}

model FeeTransaction {
  id          Int       @id @default(autoincrement())
  studentId   Int
  amount      Int
  status      PaymentStatus
  easebuzzRef String?
  paidAt      DateTime?
  type        String    @default("TUITION") // Added missing field

  student     Student @relation(fields: [studentId], references: [id])
}


// ---------------------
// HOSTEL
// ---------------------

model HostelAllocation {
  id         Int      @id @default(autoincrement())
  studentId  Int      @unique
  roomNo     String?
  bedNo      String?
  startDate  DateTime?
  
  fees       Int?     // Added missing field
  isVacated  Boolean  @default(false) // Added missing field

  student    Student @relation(fields: [studentId], references: [id])
}


// ---------------------
// LIBRARY
// ---------------------

model LibraryBook {
  id         Int      @id @default(autoincrement())
  title      String
  author     String?
  isbn       String?
  copies     Int      @default(1)

  logs       LibraryLog[]
}

model LibraryLog {
  id         Int      @id @default(autoincrement())
  studentId  Int
  bookId     Int
  issuedAt   DateTime @default(now())
  returnedAt DateTime?
  fineAmount Int?     // Added missing field

  student    Student     @relation(fields: [studentId], references: [id])
  book       LibraryBook @relation(fields: [bookId], references: [id])
}


// ---------------------
// ODC MODULE
// ---------------------

model OdcRecord {
  id         Int      @id @default(autoincrement())
  studentId  Int
  hotelName  String
  date       DateTime
  amount     Int?
  status     String?  // Added missing field

  student    Student @relation(fields: [studentId], references: [id])
}


// ---------------------
// PLACEMENTS
// ---------------------

model PlacementDrive {
  id           Int      @id @default(autoincrement())
  company      String
  role         String
  date         DateTime
  package      Float?   // Added missing field (LPA)

  applications PlacementApplication[]
}

model PlacementApplication {
  id         Int      @id @default(autoincrement())
  driveId    Int
  studentId  Int
  status     PlacementStatus @default(APPLIED)

  drive      PlacementDrive @relation(fields: [driveId], references: [id])
  student    Student        @relation(fields: [studentId], references: [id])
}

enum PlacementStatus {
  APPLIED
  SHORTLISTED
  SELECTED
  REJECTED
}


// ---------------------
// STUDENT MONITORING (L1/L2/L3)
// ---------------------

model StudentIssue {
  id         Int         @id @default(autoincrement())
  studentId  Int
  level      IssueLevel
  remarks    String?
  resolved   Boolean      @default(false) // Added missing field
  createdAt  DateTime     @default(now())

  student    Student      @relation(fields: [studentId], references: [id])
}

enum IssueLevel {
  L1
  L2
  L3
}

// ---------------------
// NOTIFICATIONS
// ---------------------

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  title     String
  message   String
  type      NotificationType @default(INFO)
  status    NotificationStatus @default(UNREAD)
  
  metadata  Json?    // { entityId: 1, entityType: 'FEE' }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id])
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
  REMINDER
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}
